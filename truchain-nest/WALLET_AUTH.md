# TruChain API Authentication Guide

This guide explains how to authenticate with the TruChain API using the available authentication methods.

## Authentication Methods

The TruChain API offers several authentication methods to suit different use cases:

### Method 1: Create a User Account (Recommended)

1. **Create an account**: Register to get a wallet address and API key
2. **Fund your wallet**: Add TruChain tokens to your wallet
3. **Authenticate**: Use your API key to get a JWT token

### Method 2: Challenge-Response Flow (For Web Applications)

1. **Request a challenge**: Get a unique message to sign with your wallet
2. **Sign the challenge**: Sign the message with your wallet (MetaMask, etc.)
3. **Verify signature**: Send the signed message back to get a JWT token

### Method 3: Direct Wallet Authentication (For Server-to-Server)

- **Single request**: Provide your wallet address and private key to get a JWT token
- **Note**: Only use this method with wallets generated by our API

## Creating a User Account

### Step 1: Create a New User

```bash
curl -X POST http://localhost:3000/users \
  -H "Content-Type: application/json" \
  -d '{
    "email": "user@example.com",
    "password": "securePassword123"
  }'
```

Response:

```json
{
  "address": "0x1234567890abcdef1234567890abcdef12345678",
  "privateKey": "0x1234567890abcdef1234567890abcdef1234567890abcdef1234567890abcdef",
  "instructions": "Fund this wallet with TruChain tokens to use our services. Keep your private key secure."
}
```

### Step 2: Check Your Wallet Balance

```bash
curl http://localhost:3000/users/wallet/0x1234567890abcdef1234567890abcdef12345678/balance
```

Response:

```json
{
  "address": "0x1234567890abcdef1234567890abcdef12345678",
  "balance": "100.0",
  "hasSufficientFunds": true
}
```

### Step 3: Get Your User Profile (After Authentication)

```bash
curl http://localhost:3000/users/profile \
  -H "Authorization: Bearer YOUR_JWT_TOKEN"
```

Response:

```json
{
  "id": "550e8400-e29b-41d4-a716-446655440000",
  "email": "user@example.com",
  "walletAddress": "0x1234567890abcdef1234567890abcdef12345678",
  "apiKey": "truc-api-550e8400e29b41d4a716446655440000",
  "createdAt": "2025-09-19T12:34:56.789Z",
  "lastLoginAt": "2025-09-19T12:34:56.789Z"
}
```

## API Key Authentication

Once you have created a user account, you can authenticate using your API key:

```bash
curl -X POST http://localhost:3000/auth/api-key \
  -H "Content-Type: application/json" \
  -d '{
    "apiKey": "truc-api-550e8400e29b41d4a716446655440000"
  }'
```

Response:

```json
{
  "accessToken": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
  "address": "0x1234567890abcdef1234567890abcdef12345678",
  "expiresAt": 1695146189123
}
```

## Challenge-Response Authentication

For web applications that integrate with wallet providers like MetaMask:

### Step 1: Request a Challenge

```bash
curl -X POST http://localhost:3000/auth/challenge \
  -H "Content-Type: application/json" \
  -d '{
    "address": "0x1234567890abcdef1234567890abcdef12345678"
  }'
```

Response:

```json
{
  "challenge": "Sign this message to authenticate with TruChain: 1695142589123",
  "expiresAt": 1695142889123
}
```

### Step 2: Sign the Challenge with Your Wallet

In a web application, you would use a wallet provider like MetaMask:

```javascript
async function signMessage(address, message) {
  if (!window.ethereum) {
    throw new Error('MetaMask is not installed');
  }
  
  try {
    const signature = await window.ethereum.request({
      method: 'personal_sign',
      params: [message, address],
    });
    
    return signature;
  } catch (error) {
    console.error('Error signing message:', error);
    throw error;
  }
}
```

### Step 3: Verify the Signature

```bash
curl -X POST http://localhost:3000/auth/verify \
  -H "Content-Type: application/json" \
  -d '{
    "address": "0x1234567890abcdef1234567890abcdef12345678",
    "challenge": "Sign this message to authenticate with TruChain: 1695142589123",
    "signature": "0xYourSignature"
  }'
```

Response:

```json
{
  "accessToken": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
  "address": "0x1234567890abcdef1234567890abcdef12345678",
  "expiresAt": 1695146189123
}
```

## Direct Wallet Authentication

For server-to-server communication using wallets generated by our API:

```bash
curl -X POST http://localhost:3000/auth/wallet-key \
  -H "Content-Type: application/json" \
  -d '{
    "address": "0x1234567890abcdef1234567890abcdef12345678",
    "privateKey": "0x1234567890abcdef1234567890abcdef1234567890abcdef1234567890abcdef"
  }'
```

Response:

```json
{
  "accessToken": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
  "address": "0x1234567890abcdef1234567890abcdef12345678",
  "expiresAt": 1695146189123
}
```

## Using the JWT Token

After authentication, include the JWT token in the `Authorization` header of your requests:

```bash
curl http://localhost:3000/blockchain/wallet-info \
  -H "Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."
```

## Node.js Example: API Key Authentication

```javascript
const axios = require('axios');

async function authenticateWithApiKey(apiBaseUrl, apiKey) {
  try {
    // API key authentication
    const response = await axios.post(`${apiBaseUrl}/auth/api-key`, {
      apiKey
    });
    
    return response.data.accessToken;
  } catch (error) {
    console.error('Authentication error:', error.response?.data || error.message);
    throw error;
  }
}

// Example usage
const apiBaseUrl = 'http://localhost:3000';
const apiKey = 'truc-api-550e8400e29b41d4a716446655440000';

authenticateWithApiKey(apiBaseUrl, apiKey)
  .then(token => {
    console.log('JWT Token:', token);
    
    // Now you can use this token for authenticated requests
    return axios.get(`${apiBaseUrl}/blockchain/wallet-info`, {
      headers: {
        Authorization: `Bearer ${token}`
      }
    });
  })
  .then(response => {
    console.log('Protected API response:', response.data);
  })
  .catch(error => {
    console.error('Error:', error.message);
  });
```

## Security Considerations

1. **API Keys**: Treat your API key like a password. Don't share it or expose it in client-side code.
2. **Private Keys**: Never share your wallet's private key. Only use it for server-to-server communication.
3. **JWT Tokens**: Have an expiration time. Request a new token when needed.
4. **HTTPS**: Always use HTTPS for production environments to prevent man-in-the-middle attacks.
5. **Wallet Funding**: Ensure your wallet has sufficient TruChain tokens to use the API services.

## Troubleshooting

- **Invalid API Key**: Ensure you're using the correct API key from your user profile.
- **Insufficient Funds**: Check your wallet balance and add more TruChain tokens if needed.
- **Invalid Signature**: Ensure you're signing the exact challenge string without any modifications.
- **Challenge Expired**: Challenges expire after 5 minutes. Request a new challenge if needed.
- **Invalid Address Format**: Ensure your Ethereum address is correctly formatted (0x prefix followed by 40 hex characters).